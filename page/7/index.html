<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta http-equiv="Cache-Control" content="max-age=86400" />
<meta name="baidu-site-verification" content="I3b2hxwJQe" />

<!-- <meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" /> -->






  <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="詹方的个人博客" />



  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="詹方的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Fang -.-">
<meta property="og:url" content="http://www.demozhan.com/page/7/index.html">
<meta property="og:site_name" content="Fang -.-">
<meta property="og:description" content="詹方的个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fang -.-">
<meta name="twitter:description" content="詹方的个人博客">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> Fang -.- </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?f060a37ef3c67e7d80e0730ccf4c5f23";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Fang -.-</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            <i class="menu-item-icon icon-next-commonweal"></i> <br />
            公益404
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','http://7xltvd.com1.z0.glb.clouddn.com/swifty_st.js','_st');

  _st('install', '8paz1yFszaADHgDv8F_P','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/05/Express代理/" itemprop="url">
                Express代理(转自Express官方教程)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-05-05T10:02:41+08:00" content="2015-05-05">
            2015-05-05
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nodejs/" itemprop="url" rel="index">
                  <span itemprop="name">nodejs</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/05/05/Express代理/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/05/05/Express代理/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>在 Express 的前面添加一个反向代理（比如 Varnish 或者 Nginx）是非常常见的,它不需要额外的配置。 在通过 app.enable(‘trust proxy’) 激活了 “trust proxy” 设置后， Express 就会知道自己在一个代理的后面，就会信任 X-Forwarded-* HTTP 头信息了。（ 通常情况下这些 HTTP 头信息是很容易被伪装的。）</p>
<p>使用了这个设置后会有一些很棒的小变化。 首先由反向代理设置的 X-Forwarded-Proto 会告诉程序它是 https 还是 http 。 这个值会影响 req.protocol 属性。</p>
<p>第二个变化是 req.ip 和 req.ips 的值会被 X-Forwarded-For 列表里的地址取代。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/04/redis统计express在线人数/" itemprop="url">
                redis统计express在线人数
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-05-04T20:48:30+08:00" content="2015-05-04">
            2015-05-04
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nodejs/" itemprop="url" rel="index">
                  <span itemprop="name">nodejs</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/05/04/redis统计express在线人数/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/05/04/redis统计express在线人数/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>##在线用户计数<br>这一小节我们讲解一个小而全的应用程序，它通过 Redis 记录在线用户数。 首先你需要创建一个package.json 文件，包含两个依赖, 一个是redis 客户端，另一个是Express。 （另外需要确认你安装了redis, 可以能过执行 $ redis-server 来确认）：</p>
<pre><code>{
  &quot;name&quot;: &quot;app&quot;,
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;dependencies&quot;: {
    &quot;express&quot;: &quot;3.x&quot;,
    &quot;redis&quot;: &quot;*&quot;
  }
}
</code></pre><p>##接下来你需要你创建一个应用程序，和一个 redis 连接：</p>
<pre><code>var express = require(&apos;express&apos;);
var redis = require(&apos;redis&apos;);
var db = redis.createClient();
var app = express();
</code></pre><p>接下来是纪录用户在线的中间件。 这里我们使用sorted sets, 它的一个好处是我们可以查询最近N毫秒内在线的用户。 我们通过传入一个时间戳来当作成员的”score”。 注意我们使用 User-Agent 作为一个标识用户的id。</p>
<pre><code>app.use(function(req, res, next){
  var ua = req.headers[&apos;user-agent&apos;];
  db.zadd(&apos;online&apos;, Date.now(), ua, next);
});
</code></pre><p>下一个中间件是通过 zrevrangebyscore 来查询上一分钟在线用户。 我们将能得到从当前时间算起在 60,000 毫秒内活跃的用户。</p>
<pre><code>app.use(function(req, res, next){
  var min = 60 * 1000;
  var ago = Date.now() - min;
  db.zrevrangebyscore(&apos;online&apos;, &apos;+inf&apos;, ago, function(err, users){
    if (err) return next(err);
    req.online = users;
    next();
  });
});
</code></pre><p>最后我们来使用它，绑定到一个端口！这些就是这个程序的一切了，在不同的浏览器里访问这个应用程序，你会看到计数的增长。</p>
<pre><code>app.get(&apos;/&apos;, function(req, res){
  res.send(req.online.length + &apos; users online&apos;);
});

app.listen(3000);
</code></pre><p>##HinocLab的app.js</p>
<pre><code>/**
 - Module dependencies.
 */

// 创建express对象和一个redis客户端连接
var express = require(&apos;express&apos;);
var redis = require(&apos;redis&apos;);
var db = redis.createClient();
var app = module.exports = express();

var routes = require(&apos;./routes&apos;)
var http = require(&apos;http&apos;)
var path = require(&apos;path&apos;)
var markdown=require(&apos;markdown-js&apos;)
var fs = require(&apos;fs&apos;);

//写入日志
var accessLogfile = fs.createWriteStream(&apos;access.log&apos;,{flags:&apos;a&apos;});
var errorLogfile = fs.createWriteStream(&apos;error.log&apos;,{flags:&apos;a&apos;});

var MongoStore = require(&apos;connect-mongo&apos;)(express);

var settings = require(&apos;./settings&apos;);
// Configuration

app.configure(function(){
  app.set(&apos;port&apos;, process.env.PORT || 3000);
  app.set(&apos;views&apos;, __dirname + &apos;/views&apos;);
  app.set(&apos;view engine&apos;, &apos;ejs&apos;);
  app.use(express.favicon(__dirname+&apos;/public/logo.ico&apos;));
//  app.use(express.logger(&apos;dev&apos;));
  app.use(express.logger({stream:accessLogfile}));
  app.use(express.bodyParser());
  app.use(express.methodOverride());
  app.use(express.cookieParser());
  app.use(express.session({
    secret: settings.cookieSecret,
    store: new MongoStore({
      db: settings.db
    })
  }));

  // 纪录用户在线的中间件 
  // 这里使用user-agent作为用户标识符
  // 这里使用sorted sets，以便查询最近N毫秒内在线的用户；
  app.use(function(req, res, next) {
      var ua = req.headers[&apos;user-agent&apos;];
      db.zadd(&apos;online&apos;, Date.now(), ua, next);
  });

  // 通过 zrevrangebyscore 来查询上一分钟在线用户。
  // 我们将能得到从当前时间算起在 60,000 毫秒内活跃的用户。
  app.use(function(req, res, next) {
      var min = 60 * 1000;
      var ago = Date.now() - min;
      db.zrevrangebyscore(&apos;online&apos;, &apos;+inf&apos;, ago, function (err, users) {
          if (err) {
              return next (err);
          }

          req.online = users;
          next ();
      });
  });



  app.use(app.router);
  app.use(express.static(path.join(__dirname, &apos;public&apos;)));
});

app.configure(&apos;development&apos;, function(){
  app.use(express.errorHandler({ dumpExceptions: true, showStack: true }));
});

app.configure(&apos;production&apos;, function(){
  app.use(function(err,req,res,next){
    var meta = &apos;[&apos; + new Date() +&apos;]&apos; +req.url + &apos;\n&apos;;
    errorLogfile.write(meta + err.stack + &apos;\n&apos;);
    next();
  });
//  app.use(express.errorHandler());
});

app.engine(&apos;md&apos;, function(path, options, fn){  
  fs.readFile(path, &apos;utf8&apos;, function(err, str){  
    if (err) return fn(err);  
    str = markdown.parse(str).toString();  
    fn(null, str);  
  });
});


// 从不同浏览器进入就可以看到同时在线用户数不断增加
app.get(&apos;/online&apos;, function(req, res){
    res.send(req.online.length + &apos; users online&apos;);
});

// Routes

// app.get(&apos;/&apos;, routes.index);
app.get(&apos;/home&apos;, routes.home);
app.get(&apos;/about&apos;, routes.about);
app.get(&apos;/report&apos;, routes.report);
app.get(&apos;/submit&apos;, routes.getsubmit);
app.post(&apos;/submit&apos;, routes.postsubmit);
app.get(&apos;/login&apos;, routes.getlogin);
app.post(&apos;/login&apos;, routes.postlogin);

app.get(&apos;/logout&apos;, routes.logout);

app.post(&apos;/modify&apos;, routes.modify);
app.get(&apos;/login&apos;, routes.getlogin);

app.get(&apos;/doc/:author/:title&apos;, routes.getdoc);

app.get(&apos;/doc&apos;, routes.getdocindex);

app.get(&apos;/xxx&apos;, function(req, res) {  
    console.log(&apos;404 handler..&apos;)  
    res.render(&apos;404&apos;, {  
        status: 404,  
        title: &apos;NodeBlog&apos;,
        user: req.session.user  
    });  
});

if(!module.parent){
  http.createServer(app).listen(app.get(&apos;port&apos;), function(){
    console.log(&quot;Express server listening on port &quot; + app.get(&apos;port&apos;));
  });
}
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/04/mac-nginx/" itemprop="url">
                mac下nginx配置
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-05-04T20:13:34+08:00" content="2015-05-04">
            2015-05-04
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nginx/" itemprop="url" rel="index">
                  <span itemprop="name">nginx</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/05/04/mac-nginx/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/05/04/mac-nginx/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="nginx简介"><a href="#nginx简介" class="headerlink" title="nginx简介"></a>nginx简介</h2><p>Nginx 是一个很牛的高性能Web和反向代理服务器, 它具有有很多非常优越的特性:</p>
<p>在高连接并发的情况下，Nginx是Apache服务器不错的替代品: Nginx在美国是做虚拟主机生意的老板们经常选择的软件平台之一. 能够支持高达 50,000 个并发连接数的响应, 感谢Nginx为我们选择了 epoll and kqueue 作为开发模型。</p>
<p>Nginx作为负载均衡服务器: Nginx 既可以在内部直接支持 Rails 和 PHP 程序对外进行服务, 也可以支持作为 HTTP代理 服务器对外进行服务. Nginx采用C进行编写, 不论是系统资源开销还是CPU使用效率都比 Perlbal 要好很多。</p>
<p>作为邮件代理服务器: Nginx 同时也是一个非常优秀的邮件代理服务器（最早开发这个产品的目的之一也是作为邮件代理服务器）, Last.fm 描述了成功并且美妙的使用经验。</p>
<p>Nginx 是一个安装非常的简单 , 配置文件 非常简洁（还能够支持perl语法）, Bugs 非常少的服务器: Nginx 启动特别容易, 并且几乎可以做到7*24不间断运行，即使运行数个月也不需要重新启动. 你还能够不间断服务的情况下进行软件版本的升级。</p>
<h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><pre><code>brew search nginx
brew install nginx
</code></pre><p>启动nginx ，sudo nginx ;访问localhost:8080 发现已出现nginx的欢迎页面了。</p>
<h2 id="常用的指令有："><a href="#常用的指令有：" class="headerlink" title="常用的指令有："></a>常用的指令有：</h2><pre><code>nginx -V 查看版本，以及配置文件地址
nginx -v 查看版本
nginx -c filename 指定配置文件
nginx -h 帮助
#重新加载配置|重启|停止|退出 nginx
nginx -s reload|reopen|stop|quit
#打开 nginx
sudo nginx
#测试配置是否有语法错误
nginx -t
</code></pre><h2 id="nginx配置目录"><a href="#nginx配置目录" class="headerlink" title="nginx配置目录"></a>nginx配置目录</h2><pre><code>vim /usr/local/etc/nginx/nginx.conf
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/04/nodejs部署1/" itemprop="url">
                MAC中nodejs部署（参考自 nodejs开发指南）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-05-04T11:34:26+08:00" content="2015-05-04">
            2015-05-04
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nodejs/" itemprop="url" rel="index">
                  <span itemprop="name">nodejs</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/05/04/nodejs部署1/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/05/04/nodejs部署1/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>在开发的过程中,通过node app.js 􏰤􏱎运行服务器􏰓可。但它不适合在产􏱏环境下使用,因为到目前为􏱒这个服务 器还有几个重大􏱓􏱔问题</p>
<p>##存在问题</p>
<p>###不支持故障恢复<br>不知你是􏱜在调试的过程中注意,􏱝程序有错误发生时,􏱞整个进程就会结束,需要重新在终端中􏱠动服务器。这一点在开发中无可厚非,但在产􏱏环境下就是􏱡重的问题 了,因为一􏱢用􏰑访问时触发了程序中􏱣个􏱤􏱥的bug􏱦􏱞个服务器就􏱧􏱨了，所以我们在部署nodejs的时候一定要注意故障恢复</p>
<p>###没有日志<br>没有错误日志和访问日志</p>
<p>###无法利用多核<br>Nodejs是单线程的，一个进程只能使用一个CPU核心</p>
<p>###独占端口<br>假如􏱞个服务器只有一个网站,或者可以给每个网站分配一个􏰇􏰈的IP地址,不会有 端口􏰦􏰧冲突的问题。而很多时􏰯为了􏲉充分利用服务器的资源,我们会在同一个服务器上建􏰈多个网站,而且这些网站可能有的是PHP，有的是Rails，有的是Node.js。不能每个进程都􏰇􏲊80端口,所以我们有􏱶要通过􏲋􏲌代理来实现基于域􏰥名的端口共享。</p>
<p>###需要手动启动<br>先前每次􏱠动服务器都是通过在􏰤􏱎行中􏰡接􏲑入􏰤􏱎来实现的,但在产􏱏环境中, 特别是在服务器重􏱠启以后,全部􏱭􏲒手动是不现实的。因此,我们应该制作一个自动启􏱠动服务器的脚􏲓本,并且通过该􏲓脚本可以实现􏲔􏱒服务器等功能。</p>
<p>##解决问题</p>
<p>###日志功能<br>Express有两种模式：调试模式、产品模式，产品模式易于部署，设置模式方法：在MAC命令行</p>
<pre><code>export NODE_ENV=production
</code></pre><p>我们实现访问􏱲􏱳日志和错误􏱲􏱳功能。访问日志􏱲􏱳就是􏲚录用􏰑对服务器的每个请求,包括􏲛􏰑端IP地址,访问时间,访问路径,服务器􏲜应以及􏲛􏰑端代理字符􏲝。而错误日志则􏲚录程序发生错误时的􏲞􏲟,由于调试中需要􏰓时􏰼看错误􏲞􏲟,将所有错误􏰡接显 示到终端􏰓可,而在产􏱏模式中,需要写入错误􏱲􏱳文件。<br>Express 提供了一个访问􏱲􏱳中间件,只需指定stream 参数为一个输出流􏰓可将访问日志写入文件。打开app.js,在最上方加入以下代码:</p>
<pre><code>var fs = require(&apos;fs&apos;);
var accessLogfile = fs.createWriteStream(&apos;access.log&apos;,{flags:&apos;a&apos;});
var errorLogfile = fs.createWriteStream(&apos;error.log&apos;,{flags:&apos;a&apos;});
</code></pre><p>􏲠􏲡􏲢然后在app.configure第一行加入</p>
<pre><code>app.use(express.logger({stream:accessLogfile}));
</code></pre><p>至于错误􏱲􏱳,需要􏰒􏰇实现错误􏲜,修􏲪改如下:</p>
<pre><code>app.configure(&apos;production&apos;, function(){
  app.use(function(err,req,res,next){
    var meta = &apos;[&apos; + new Date() +&apos;]&apos; +req.url + &apos;\n&apos;;
    errorLogfile.write(meta + err.stack + &apos;\n&apos;);
    next();
  });
//  app.use(express.errorHandler());
});
</code></pre><p>为了产生一个错误,我们􏲪改routes/index.js 中􏰽 / 􏰾的􏲜应函数,加入以下代码: </p>
<pre><code>throw new Error(&apos;An error for test purposes.&apos;);
</code></pre><p>完整的app.js代码如下</p>
<pre><code>/**
 - Module dependencies.
 */
var express = require(&apos;express&apos;)
  , routes = require(&apos;./routes&apos;)
  , http = require(&apos;http&apos;)
  , path = require(&apos;path&apos;)
  , markdown=require(&apos;markdown-js&apos;)
  , fs = require(&apos;fs&apos;);

//写入日志
var accessLogfile = fs.createWriteStream(&apos;access.log&apos;,{flags:&apos;a&apos;});
var errorLogfile = fs.createWriteStream(&apos;error.log&apos;,{flags:&apos;a&apos;});

var app = express();
var MongoStore = require(&apos;connect-mongo&apos;)(express);

var settings = require(&apos;./settings&apos;);
// Configuration

app.configure(function(){
  app.set(&apos;port&apos;, process.env.PORT || 3300);
  app.set(&apos;views&apos;, __dirname + &apos;/views&apos;);
  app.set(&apos;view engine&apos;, &apos;ejs&apos;);
  app.use(express.favicon(__dirname+&apos;/public/logo.ico&apos;));
//  app.use(express.logger(&apos;dev&apos;));
  app.use(express.logger({stream:accessLogfile}));
  app.use(express.bodyParser());
  app.use(express.methodOverride());
  app.use(express.cookieParser());
  app.use(express.session({
    secret: settings.cookieSecret,
    store: new MongoStore({
      db: settings.db
    })
  }));
  app.use(app.router);
  app.use(express.static(path.join(__dirname, &apos;public&apos;)));
});

app.configure(&apos;development&apos;, function(){
  app.use(express.errorHandler({ dumpExceptions: true, showStack: true }));
});

app.configure(&apos;production&apos;, function(){
  app.use(function(err,req,res,next){
    var meta = &apos;[&apos; + new Date() +&apos;]&apos; +req.url + &apos;\n&apos;;
    errorLogfile.write(meta + err.stack + &apos;\n&apos;);
    next();
  });
//  app.use(express.errorHandler());
});

app.engine(&apos;md&apos;, function(path, options, fn){  
  fs.readFile(path, &apos;utf8&apos;, function(err, str){  
    if (err) return fn(err);  
    str = markdown.parse(str).toString();  
    fn(null, str);  
  });
});

// Routes

app.get(&apos;/&apos;, routes.index);
app.get(&apos;/home&apos;, routes.home);
app.get(&apos;/about&apos;, routes.about);
app.get(&apos;/report&apos;, routes.report);
app.get(&apos;/submit&apos;, routes.getsubmit);
app.post(&apos;/submit&apos;, routes.postsubmit);
app.get(&apos;/login&apos;, routes.getlogin);
app.post(&apos;/login&apos;, routes.postlogin);

app.get(&apos;/logout&apos;, routes.logout);

app.post(&apos;/modify&apos;, routes.modify);
app.get(&apos;/login&apos;, routes.getlogin);

app.get(&apos;/doc/:author/:title&apos;, routes.getdoc);

app.get(&apos;/doc&apos;, routes.getdocindex);

app.get(&apos;/xxx&apos;, function(req, res) {  
    console.log(&apos;404 handler..&apos;)  
    res.render(&apos;404&apos;, {  
        status: 404,  
        title: &apos;NodeBlog&apos;,
        user: req.session.user  
    });  
});

http.createServer(app).listen(app.get(&apos;port&apos;), function(){
  console.log(&quot;Express server listening on port &quot; + app.get(&apos;port&apos;));
});
</code></pre><p>##多核多线程使用（cluster使用）<br>从0.6 版本开始，Node.js 提供了一个核心模块:cluster。cluster的功能是生成与􏱝当前进程􏰫相同的􏴸进程,并且􏺲允许􏴬进程和􏴸进程之间共享端口。Node.js另的􏰝一个核心模块 child_process 也提供了􏰫􏲬的进程生成功能,但最大的区别在于cluster允许跨进程端口复用,给我们的网络服务器开发带来了很大的方便􏺳</p>
<p>为了在外部模块调用app.js􏱦首先需要􏺴􏱒禁止服务器自启􏱠动。􏲪修改app.js,在app.listen (3000); 前后加上􏺵􏺭判断语􏷵:</p>
<pre><code>if(!module.parent){
  http.createServer(app).listen(app.get(&apos;port&apos;), function(){
    console.log(&quot;Express server listening on port &quot; + app.get(&apos;port&apos;));
  });
}
</code></pre><p>这个语􏷵的功能是􏺵􏺭􏱝前模块是不是由其他模块调用的,如果不是,说􏴹它是􏰡接􏱠直接启动的,此时􏱠启动调试服务器。如果是,则不自动􏱠动服务器。以后􏰡直接调用node app.js服务器会􏰡接运行,但在其他模块中调用require(‘./app’) 则不会自动启动,需要􏲳显式地调用listen() 函数。</p>
<p>接下来就让我们通过cluster 调用app.js􏺳。创建cluster.js􏱦内容如下所示:</p>
<pre><code>var cluster = require(&apos;cluster&apos;);
var os = require(&apos;os&apos;);

// 获取cpu数量
var numCPUs = os.cpus().length;

var workers = {};

if(cluster.isMaster){
    // 主线程分支
    cluster.on(&apos;death&apos;,function (worker) {
        // 当一个工作进程结束时,重启工作进程
        delete workers[worker.pid];
        worker = cluster.fork();
        workers[worker.pid] = worker;
    });

    // 初始开启与cpu数量相同的工作进程
    for (var i = 0; i &lt; numCPUs; i++) {
        var worker = cluster.fork();
        workers[worker.pid] = worker;
    }
} else {
    // 工作进程分支，启动服务器
    var app = require(&apos;./app&apos;);
    var http = require(&apos;http&apos;);
    http.createServer(app).listen(app.get(&apos;port&apos;), function(){
        console.log(&quot;Express server listening on port &quot; + app.get(&apos;port&apos;));
     });
}

// 当主进程被终止，关闭所有工作进程
process.on(&apos;SIGTERM&apos;,function () {
    for(var pid in workers){
        process.kill(pid);
    }
    process.exit(0);
});
</code></pre><p>对应修改app.js</p>
<pre><code>var app = module.exports = express();

if(!module.parent){
    http.createServer(app).listen(app.get(&apos;port&apos;), function(){
    console.log(&quot;Express server listening on port &quot; + app.get(&apos;port&apos;));
  });
}
</code></pre><p>cluster.js 的功能是创建与CPU 核心个数􏰫同的服务器进程,以􏵎􏳢􏲉分利用多核CPU 的 资源。主进程生成􏹁􏹂个工作进程,并􏶍听工作进程结􏱟事件,􏱝工作进程结􏱟时,重新􏱠启动一个工作进程。分支进程产生时会自顶􏲌下重新􏵱行􏱝前程序,并通过分支􏺵􏺭进入工作进程分支,在其中读取模块并􏱠动服务器。通过cluster􏱠启动的工作进程可以􏰡接实现端口复用,因此所有工作进程只需􏶍听同一端口。􏱝主进程终􏱒时,还要主动关闭所有工作进程。</p>
<p>##启动脚本<br>接下来,我们还需要一个􏱠脚􏲓本来简化维􏷁工作。如果你维􏷁过Linux 服务器,会对 /etc/init.d/ 下面的􏲓脚本有印􏵑象。例如使用/etc/init.d/nginx start 和/etc/init.d/ nginx stop 可以􏱠动和关闭Nginx 服务器。我们通过bash也来实现一个􏰘􏲬的功能, 创建microblog 并使用chmod +x microblog 􏵝􏼢其􏵱执行权限脚本内容为:</p>
<pre><code>#! /bin/sh

NODE_ENV=production
DAEMON=&quot;node cluster.js&quot;
NAME=HINOCLab
DESC=HINOCLab
PIDFILE=&quot;HINOCLab.pid&quot;

case &quot;$1&quot; in
    start)
        echo &quot;starting $DESC: &quot;
            nohup $DAEMON &gt; /dev/null &amp;
        echo $! &gt; $PIDFILE
        echo &quot;$NAME.&quot;
            ;;
    stop)
        echo &quot;stoping $DESC: &quot;
            pid=&apos;cat $PIDFILE&apos;
        kill $pid
            rm $PIDFILE
        echo &quot;$NAME.&quot;
            ;;
esac
exit 0
</code></pre><p><em>注意不能有多余的空格</em></p>
<p>##共享80端口<br>􏽂􏽃虚拟主机就是让多个网站共享使用同一服务器，同一IP地址通过域􏰥的不同来􏳾分请求。主流的HTTP服务器都提供了􏽂􏽃主机支持，如Nginx、Apache、IIS等。以Nginx为例,介绍如何通过􏲋􏲌代理实现Node.js 􏽂􏽃主机。</p>
<p>在Nginx中设置􏲋􏲌代理和􏽂􏽃主机非常简􏰒单，下面是配置文件的一个示例:</p>
<pre><code>server {
    listen 80;
    server_name mysite.com;
    location / {
    proxy_pass http://localhost:3000;
    }
}
</code></pre><p>这个配置文件的功能是􏶍听访问mysite.com 80 端口的请求,并将所有的请求􏴔发给 <a href="http://localhost:3000，" target="_blank" rel="external">http://localhost:3000，</a> 到的Node.js 服务器。现在访问<a href="http://mysite.com/,就􏰫􏱝于服务器访问" target="_blank" rel="external">http://mysite.com/,就􏰫􏱝于服务器访问</a> <a href="http://localhost:3000" target="_blank" rel="external">http://localhost:3000</a> 了。<br>在􏳸加了􏽂􏽃主机以后,还可以在Nginx配置文件中􏳸加访问􏷦􏴠文件的规则(具体请<br>参考Nginx文档),􏷫去app.js中的app.use(express.static(__dirname + ‘/public’));。 这􏵌可以􏰡接让Nginx 来处理􏷦􏴠文件，􏰕少􏲋􏲌代理以及Node.js 的开销。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/03/mongodb-repair/" itemprop="url">
                mongodb repair
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-05-03T22:24:13+08:00" content="2015-05-03">
            2015-05-03
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/mongodb/" itemprop="url" rel="index">
                  <span itemprop="name">mongodb</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/05/03/mongodb-repair/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/05/03/mongodb-repair/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><pre><code>exception in initAndListen: 0 assertion src/mongo/db/storage/extent.h:80, terminating
</code></pre><p>修复方法：</p>
<p>这算是一个Mongod 启动的一个常见错误，非法关闭的时候，lock 文件没有干掉，第二次启动的时候检查到有lock 文件的时候，就报这个错误了。</p>
<p>解决方法：进入 mongod 上一次启动的时候指定的 data 目录  –dbpath=/data/mongodb</p>
<p>删除掉该文件:</p>
<pre><code>rm /data/mongodb/mongo.lock --linux

del /data/mongodb/mongo.lock --windows
</code></pre><p>再执行:</p>
<pre><code>./mongod  --repair
</code></pre><p>启动：</p>
<pre><code>/usr/local/src/mongodb-linux-x86_64-2.0.2/bin/mongod --port=27017 --pidfilepath=/var/run/mongod.pid --dbpath=/data/mongodb --directoryperdb --nojournal --noauth
</code></pre><p>OK，问题解决。</p>
<p>正确关闭mongod 的方法：进入mongo shell</p>
<pre><code>use admin

db.shutdownServer()
</code></pre><p>也可以按照文档粗暴的杀掉它，它内部应该有KILL信号处理程序。</p>
<pre><code>killall mongod
</code></pre><p>请不要 kill -9 ，会造成文件数据混乱丢失 repair 也无力回天。</p>
<pre><code>ctrl+c 可以退出mongo的界面 或是ext
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/04/02/thinkphp-sae/" itemprop="url">
                sae中thinkphp使用storage存储的相关问题
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-04-02T12:17:36+08:00" content="2015-04-02">
            2015-04-02
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/04/02/thinkphp-sae/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/04/02/thinkphp-sae/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p><em>TIPS:首先声明使用sae实在是因为我的豆豆用不完</em></p>
<p>##sae中上传文件或者图片的方法<br>在sae中上传图片的方法基本没有变化<br>主要需要注意上传路径的设置，如下</p>
<pre><code>$upload-&gt;savePath =  &apos;/Public/upload&apos;;   // 设置附件上传目录
</code></pre><p>由于在config_sae.php中已经对/Public/upload有设置了</p>
<pre><code>&apos;/Public/upload&apos;=&gt;sae_storage_root(&apos;public&apos;).&apos;/upload&apos;,
</code></pre><p>跟据上面的设置，默认上传到storage服务中的Public文件夹中</p>
<pre><code>public function addHandle(){
    if(!IS_POST){
        halt(&apos;页面不存在&apos;);
    }

    import(&apos;ORG.Net.UploadFile&apos;);
    $upload = new UploadFile();                 // 实例化上传类

    $upload-&gt;savePath =  &apos;/Public/upload&apos;;   // 设置附件上传目录
    $upload-&gt;allowExts  = array(
        &apos;jpg&apos;,&apos;png&apos;,&apos;gif&apos;,&apos;bmp&apos;
        );// 设置附件上传类型
    // 开启缩略图
    $upload-&gt;thumb = true;
    //设置需要生成缩略图的文件后缀
    $upload-&gt;thumbPrefix = &apos;l_&apos;;  //生产1张缩略图
    //设置缩略图最大宽度
    $upload-&gt;thumbMaxWidth = &apos;100&apos;;
    //设置缩略图最大高度
    $upload-&gt;thumbMaxHeight = &apos;100&apos;;

    if (!$upload-&gt;upload()) {
        $this-&gt;error(&apos;上传失败&apos;);
    }

    //取得成功上传的文件信息
    $info = $upload-&gt;getUploadFileInfo();

    $_POST[&apos;off&apos;] = 0;
    $_POST[&apos;savename&apos;] = $info[0][&apos;savename&apos;];

    if(M(&apos;fruit&apos;)-&gt;add($_POST) ){
        $this-&gt;success(&apos;添加水果成功&apos;,U(&apos;Fruit/index&apos;));
    } else{
        $this-&gt;error(&apos;添加失败，请联系开发人员&apos;);
    }
}
</code></pre><p>完成上传功能后，上传的图片名为<code>551cb261dcdbc.png</code><br>但是存储在storage Public文件夹下面的文件名为upload551cb261dcdbc.png<br>其中缩略图文件名l_upload551cb261dcdbc.png<br>所以在处理的过程中还有一些技巧</p>
<p>##显示图片<br>在config_sae.php中添加</p>
<pre><code>&apos;/stor&apos;=&gt;sae_storage_root(&apos;public&apos;),
</code></pre><p>然后在显示页面添加</p>
<pre><code>&lt;td&gt;
    &lt;img src=&quot;/stor/l_upload{$v.savename}&quot; /&gt;
&lt;/td&gt;
</code></pre><p>##删除图片</p>
<pre><code>public function deleteFruit(){
    $fruit = M(&apos;fruit&apos;)-&gt;where(array(&apos;id&apos; =&gt; I(&apos;id&apos;) ))-&gt;select();
    $name1 = &apos;/Public/upload&apos;.$fruit[0][&apos;savename&apos;];////////////
    $name2 = &apos;/Public/l_upload&apos;.$fruit[0][&apos;savename&apos;];//////////

    if (M(&apos;fruit&apos;)-&gt;where(array(&apos;id&apos; =&gt; I(&apos;id&apos;)))-&gt;delete()) {
        sae_unlink($name1);////////
        sae_unlink($name2);////////
        $this-&gt;success(&apos;删除成功&apos;);
    }else{
        $this-&gt;error(&apos;删除失败&apos;);
    }
}
</code></pre><p>其中在Thinkphp/Extend/Engine/Sae/Common/sae_functions.php<br>//平滑函数，sae和本地都可以用，增加系统平滑性</p>
<pre><code>function sae_unlink($filePath) {
    if (IS_SAE) {
        $arr = explode(&apos;/&apos;, ltrim($filePath, &apos;./&apos;));
        $domain = array_shift($arr);

        // echo $domain;

        $filePath = implode(&apos;/&apos;, $arr);

        // echo $filePath;

        $s = Think::instance(&apos;SaeStorage&apos;);
        return $s-&gt;delete($domain, $filePath);
    } else {
        return unlink($filePath);
    }
}
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/31/sae-mac-svn/" itemprop="url">
                mac中使用svn从sae下载应用
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-31T21:18:13+08:00" content="2015-03-31">
            2015-03-31
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/linux-unix-macos/" itemprop="url" rel="index">
                  <span itemprop="name">linux/unix/macos</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/31/sae-mac-svn/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/31/sae-mac-svn/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>##svn版本过期<br>在使用svn过程中，首先出现的问题是svn无法使用如下命令</p>
<pre><code>svn co https://svn.sinaapp.com/myhello
</code></pre><p>检测结果svn版本为1.6.5，版本过低，只要是因为mac升级到10.10</p>
<p>解决方案：（最简单，最暴力）<br>    卸载Xcode，重新安装最新版本，因为Xcode会自动安装svn</p>
<p>##svn的使用</p>
<p>###首先将应用同步到本地</p>
<pre><code>svn co https://svn.sinaapp.com/myhello
</code></pre><p>上传代码</p>
<pre><code>svn ci -m &quot;submit code&quot;  # 注意，这里填写的submit code为更新的理由，必填项
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/30/nodejs-in-heroku/" itemprop="url">
                Getting Started with Node.js on Heroku（heroku官网教程）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-30T20:40:23+08:00" content="2015-03-30">
            2015-03-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nodejs/" itemprop="url" rel="index">
                  <span itemprop="name">nodejs</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/30/nodejs-in-heroku/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/30/nodejs-in-heroku/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>##Introduction<br>This tutorial will have you deploying a Node.js app in minutes.</p>
<p>Hang on for a few more minutes to learn how it all works, so you can make the most out of Heroku.</p>
<p>The tutorial assumes that you have a free Heroku account, and that you have Node.js and npm installed.</p>
<p>##Set up<br>In this step you will install the Heroku Toolbelt. This provides you access to the Heroku Command Line utility, as well as git and Foreman, tools you’ll use in later steps.</p>
<pre><code>Download Heroku Toolbelt for Mac OS X
</code></pre><p>Once installed, you can use the heroku command from your command shell.</p>
<p>Log in using the email address and password you used when creating your Heroku account:</p>
<pre><code>$ heroku login
Enter your Heroku credentials.
Email: zeke@example.com
Password:
Authentication successful.
</code></pre><p>Authenticating is required to allow both the heroku and git commands to operate.</p>
<p><em>Note that if you’re behind a firewall that requires use of a proxy to connect with external HTTP/HTTPS services, you can set the HTTP_PROXY or HTTPS_PROXY environment variables before running the heroku command.</em></p>
<p>##Prepare the app<br>In this step, you will prepare a simple application that can be deployed.</p>
<p>Execute the following commands to clone the sample application:</p>
<pre><code>$ git clone https://github.com/heroku/node-js-getting-started.git
$ cd node-js-getting-started
</code></pre><p>You now have a functioning git repository that contains a simple application as well as a package.json file, which is used by Node’s dependency manager.</p>
<p>##Deploy the app<br>In this step you will deploy the app to Heroku.</p>
<p>Create an app on Heroku, which prepares Heroku to receive your source code.</p>
<pre><code>$ heroku create
Creating sharp-rain-871... done, stack is cedar-14
http://sharp-rain-871.herokuapp.com/ | https://git.heroku.com/sharp-rain-871.git
Git remote heroku added
</code></pre><p>When you create an app, a git remote (called <code>heroku</code>) is also created and associated with your local git repository.</p>
<p>Heroku generates a random name (in this case <code>sharp-rain-871</code>) for your app - you can pass a parameter to specify your own, or rename it later with heroku apps:rename.</p>
<p>Now deploy your code:</p>
<pre><code>$ git push heroku master
Counting objects: 343, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (224/224), done.
Writing objects: 100% (250/250), 238.01 KiB, done.
Total 250 (delta 63), reused 0 (delta 0)

-----&gt; Node.js app detected
-----&gt; Resolving engine versions
   Using Node.js version: 0.10.3
   Using npm version: 1.2.18
-----&gt; Fetching Node.js binaries
-----&gt; Vendoring node into slug
-----&gt; Installing dependencies with npm
   ....
   Dependencies installed
-----&gt; Building runtime environment
-----&gt; Discovering process types
   Procfile declares types -&gt; web

-----&gt; Compiled slug size: 4.1MB
-----&gt; Launching... done, v9
   http://sharp-rain-871.herokuapp.com deployed to Heroku

To git@heroku.com:sharp-rain-871.git
* [new branch]      master -&gt; master
</code></pre><p>The application is now deployed. Ensure that at least one instance of the app is running:</p>
<pre><code>$ heroku ps:scale web=1
</code></pre><p>Now visit the app at the URL generated by its app name. As a handy shortcut, you can open the website as follows:</p>
<pre><code>$ heroku open
</code></pre><p>##View logs<br>Heroku treats logs as streams of time-ordered events aggregated from the output streams of all your app and Heroku components, providing a single channel for all of the events.</p>
<p>View information about your running app using one of the logging commands, heroku logs:</p>
<pre><code>$ heroku logs --tail
2011-03-10T10:22:30-08:00 heroku[web.1]: State changed from created to starting
2011-03-10T10:22:32-08:00 heroku[web.1]: Running process with command: `node index.js`
2011-03-10T10:22:33-08:00 heroku[web.1]: Listening on 18320
2011-03-10T10:22:34-08:00 heroku[web.1]: State changed from starting to up
</code></pre><p>Visit your application in the browser again, and you’ll see another log message generated.</p>
<p>Press Control+C to stop streaming the logs</p>
<p>##Define a Procfile<br>Use a Procfile, a text file in the root directory of your application, to explicitly declare what command should be executed to start your app.</p>
<p>The Procfile in the example app you deployed looks like this:</p>
<pre><code>web: node index.js
</code></pre><p>This declares a single process type, web, and the command needed to run it. The name web is important here. It declares that this process type will be attached to the HTTP routing stack of Heroku, and receive web traffic when deployed.</p>
<p>Procfiles can contain additional process types. For example, you might declare one for a background worker process that processes items off of a queue.</p>
<p>##Scale the app<br>Right now, your app is running on a single web dyno. Think of a dyno as a lightweight container that runs the command specified in the Procfile.</p>
<p>You can check how many dynos are running using the ps command:</p>
<pre><code>$ heroku ps
=== web (1X): `node index.js`
web.1: up 2014/04/25 16:26:38 (~ 1s ago)
</code></pre><p>Having only a single web dyno running will result in the dyno going to sleep after one hour of inactivity. This causes a delay of a few seconds for the first request upon waking. Subsequent requests will perform normally.</p>
<p>To avoid this, you can scale to more than one web dyno. For example:</p>
<pre><code>$ heroku ps:scale web=2
</code></pre><p>For abuse prevention, scaling the application may require account verification. If your account has not been verified, you will be directed to visit the verification site.</p>
<p>For each application, Heroku provides 750 free dyno-hours. Running your app at 2 dynos would exceed this free, monthly allowance, so scale back:</p>
<pre><code>$ heroku ps:scale web=1
</code></pre><p>##Declare app dependencies<br>Heroku recognizes an app as Node.js by the existence of a package.json file in the root directory. For your own apps, you can create one by running npm init.</p>
<p>The demo app you deployed already has a package.json, and it looks something like this:</p>
<pre><code>{
  &quot;name&quot;: &quot;node-js-getting-started&quot;,
  &quot;version&quot;: &quot;0.1.2&quot;,
  ...
  &quot;dependencies&quot;: {
    &quot;express&quot;: &quot;~4.9.x&quot;
  },
  ...
  &quot;engines&quot;: {
    &quot;node&quot;: &quot;0.10.x&quot;
  },
}
</code></pre><p>The package.json file determines both the version of Node.js that will be used to run your application on Heroku, as well as the dependencies that should be installed with your application. When an app is deployed, Heroku reads this file and installs the appropriate node version together with the dependencies using the npm install command.</p>
<p>Run this command in your local directory to install the dependencies, preparing your system for running the app locally:</p>
<pre><code>$ npm install
npm http GET https://registry.npmjs.org/express
npm http 304 https://registry.npmjs.org/express
npm http GET https://registry.npmjs.org/stream-spigot
npm http GET https://registry.npmjs.org/connect/2.12.0
...
express@4.9.4 node_modules/express
+---methods@0.1.0
+---merge-descriptors@0.0.1
+---range-parser@0.0.4
+---cookie-signature@1.0.1
+---debug@2.0.0
+---fresh@0.2.0
+---buffer-crc32@0.2.1
+---cookie@0.1.0
+---mkdirp@0.3.5
+---send@0.9.2 (destroy@1.0.3, ms@0.6.2, mime@1.2.11)
...
</code></pre><p>Once dependencies are installed, you will be ready to run your app locally.</p>
<p>##Run the app locally<br>Now start your application locally using Foreman, which was installed as part of the Toolbelt:</p>
<pre><code>$ foreman start web
14:39:04 web.1     | started with pid 24384
14:39:04 web.1     | Listening on 5000
</code></pre><p>Just like Heroku, Foreman examines the Procfile to determine what to run.</p>
<p>Your app will now be running at localhost:5000. Test that it’s working with curl or a web browser, then Ctrl-C to exit.</p>
<p>Foreman doesn’t just run your app - it also sets “config vars”, something you’ll encounter in a later tutorial.</p>
<p>##Push local changes<br>In this step you’ll learn how to propagate a local change to the application through to Heroku. As an example, you’ll modify the application to add an additional dependency and the code to use it.</p>
<p>Modify package.json to include a dependency for cool-ascii-faces:</p>
<pre><code>&quot;dependencies&quot;: {
  &quot;express&quot;: &quot;~4.9.x&quot;,
  &quot;cool-ascii-faces&quot;: &quot;~1.3.x&quot;
},
</code></pre><p>Modify index.js so that it requires this module at the start. Also modify the call to route that handles ‘/‘ to use it. Your final code should look like this:</p>
<pre><code>var express = require(&apos;express&apos;)
var app = express();
var cool = require(&apos;cool-ascii-faces&apos;);

app.set(&apos;port&apos;, (process.env.PORT || 5000))

app.get(&apos;/&apos;, function(request, response) {
  response.send(cool());
});

app.listen(app.get(&apos;port&apos;), function() {
  console.log(&quot;Node app is running at localhost:&quot; + app.get(&apos;port&apos;))
})
</code></pre><p>Now test locally:</p>
<pre><code>$ npm install
$ foreman start
</code></pre><p>Visiting your application at <code>http://localhost:5000/</code>, you should see cute faces displayed on each refresh: ( ⚆ _ ⚆ ).</p>
<p>Now deploy. Almost every deploy to Heroku follows this same pattern. First, add the modified files to the local git repository:</p>
<pre><code>$ git add .
</code></pre><p>Now commit the changes to the repository:</p>
<pre><code>$ git commit -m &quot;Demo&quot;
</code></pre><p>Now deploy, just as you did previously:</p>
<pre><code>$ git push heroku master
</code></pre><p>Finally, check that everything is working:</p>
<pre><code>$ heroku open
</code></pre><p>##Provision add-ons<br>Add-ons are third-party cloud services that provide out-of-the-box additional services for your application, from persistence through logging to monitoring and more.</p>
<p>By default, Heroku stores 1500 lines of logs from your application. However, it makes the full log stream available as a service - and several add-on providers have written logging services that provide things such as log persistence, search, and email and SMS alerts when certain conditions are met.</p>
<p>Provision the papertrail logging add-on:</p>
<pre><code>$ heroku addons:add papertrail
Adding papertrail on sharp-rain-871... done, v4 (free)
Welcome to Papertrail. Questions and ideas are welcome (support@papertrailapp.com). Happy logging!
Use `heroku addons:docs papertrail` to view documentation.
</code></pre><p>To help with abuse prevention, provisioning an add-on may require account verification. If your account has not been verified, you will be directed to visit the verification site.</p>
<p>The add-on is now deployed and configured for your application. You can list add-ons for your app like so:</p>
<pre><code>$ heroku addons
</code></pre><p>To see this particular add-on in action, visit your application’s Heroku URL a few times. Each visit will generate more log messages, which should now get routed to the papertrail add-on. Visit the papertrail console to see the log messages:</p>
<pre><code>$ heroku addons:open papertrail
</code></pre><p>A console will open up, showing the latest log events, and providing you with an interface to search and set up alerts:</p>
<p>##Start a console<br>You can run a command, typically scripts and applications that are part of your app, in a one-off dyno using the heroku run command. It can also be used to launch a REPL process attached to your local terminal for experimenting in your app’s environment:</p>
<pre><code>$ heroku run node
Running `node` attached to terminal... up, ps.1
&gt;
</code></pre><p>If you receive an error, Error connecting to process, then you may need to configure your firewall.</p>
<p>When the console starts, it has nothing loaded other than the Node.js standard library. From here you can require some of your application files.</p>
<p>For example, you will be be able to run the following:</p>
<pre><code>&gt; var cool = require(&apos;cool-ascii-faces&apos;)
&gt; cool()
( ⚆ _ ⚆ )
</code></pre><p>To get a real feel for how dynos work, you can create another one-off dyno and run the bash command, which opens up a shell on that dyno. You can then execute commands there. Each dyno has its own ephemeral filespace, populated with your app and its dependencies - once the command completes (in this case, bash), the dyno is removed.</p>
<pre><code>$ heroku run bash
Running `bash` attached to terminal... up, run.3052
~ $ ls
Procfile  README.md  composer.json  composer.lock  vendor  views  web
~ $ exit
exit
</code></pre><p>Don’t forget to type exit to exit the shell and terminate the dyno.</p>
<p>##Define config vars<br>Heroku lets you externalise configuration - storing data such as encryption keys or external resource addresses in config vars.</p>
<p>At runtime, config vars are exposed as environment variables to the application. For example, modify index.js so that the method repeats an action depending on the value of the TIMES environment variable:</p>
<pre><code>app.get(&apos;/&apos;, function(request, response) {
  var result = &apos;&apos;
  var times = process.env.TIMES || 5
  for (i=0; i &lt; times; i++)
    result += cool();
  response.send(result);
});
</code></pre><p>Foreman will automatically set up the environment based on the contents of the .env file in your local directory. Create a .env file that has the following contents:</p>
<pre><code>TIMES=2
</code></pre><p>If you run the app with foreman start, you’ll see two faces will be generated every time.</p>
<p>To set the config var on Heroku, execute the following:</p>
<pre><code>$ heroku config:set TIMES=2
</code></pre><p>View the config vars that are set using heroku config:</p>
<pre><code>$ heroku config
== sharp-rain-871 Config Vars
PAPERTRAIL_API_TOKEN: erdKhPeeeehIcdfY7ne
TIMES: 2
</code></pre><p>Deploy your changed application to Heroku to see this in action.</p>
<p>##Provision a database<br>The add-on marketplace has a large number of data stores, from Redis and MongoDB providers, to Postgres and MySQL. In this step you will add a free Heroku Postgres Starter Tier dev database to your app.</p>
<p>Add the database:</p>
<pre><code>$ heroku addons:add heroku-postgresql:hobby-dev
Adding heroku-postgresql:hobby-dev... done, v3 (free)
</code></pre><p>This creates a database, and sets a DATABASE_URL environment variable (you can check by running heroku config).</p>
<p>Edit your package.json file to add the pg npm module to your dependencies:</p>
<pre><code>&quot;dependencies&quot;: {
    &quot;pg&quot;: &quot;4.x&quot;,
    &quot;express&quot;: &quot;~4.9.x&quot;,
    &quot;cool-ascii-faces&quot;: &quot;~1.3.x&quot;
}
</code></pre><p>Type npm install to install the new module for running your app locally. Now edit your index.js file to use this module to connect to the database specified in your DATABASE_URL environment variable:</p>
<pre><code>var pg = require(&apos;pg&apos;);

app.get(&apos;/db&apos;, function (request, response) {
  pg.connect(process.env.DATABASE_URL, function(err, client, done) {
    client.query(&apos;SELECT * FROM test_table&apos;, function(err, result) {
      done();
      if (err)
       { console.error(err); response.send(&quot;Error &quot; + err); }
      else
       { response.send(result.rows); }
    });
  });
})
</code></pre><p>This ensures that when you access your app using the /db route, it will return all rows in the test_table table.</p>
<p>Deploy this to Heroku. If you access /db you will receive an error as there is no table in the database. Assuming that you have Postgres installed locally, use the heroku pg:psql command to connect to the remote database, create a table and insert a row:</p>
<pre><code>$ heroku pg:psql
psql (9.3.2, server 9.3.3)
SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)
Type &quot;help&quot; for help.
=&gt; create table test_table (id integer, name text);
CREATE TABLE
=&gt; insert into test_table values (1, &apos;hello database&apos;);
INSERT 0 1
=&gt; \q
</code></pre><p>Now when you access your app’s /db route, you will see something like this:</p>
<pre><code>[
  {
    &quot;id&quot;: 1,
    &quot;name&quot;: &quot;hello database&quot;
  }
]
</code></pre><p>Read more about Heroku PostgreSQL.</p>
<p>A similar technique can be used to install MongoDB or Redis add-ons.</p>
<p>##Next steps<br>You now know how to deploy an app, change its configuration, view logs, scale, and attach add-ons.</p>
<p>Here’s some recommended reading. The first, an article, will give you a firmer understanding of the basics. The second is a pointer to the main Node.js category here on Dev Center:</p>
<ul>
<li>Read <code>How Heroku Works(https://devcenter.heroku.com/articles/how-heroku-works)</code> for a technical overview of the concepts you’ll encounter while writing, configuring, deploying and running applications.</li>
<li>Read <code>Deploying Node.js Apps on Heroku(https://devcenter.heroku.com/articles/deploying-nodejs)</code> to understand how to take an existing Node.js app and deploy it to Heroku.</li>
<li>Visit the <code>Node.js category(https://devcenter.heroku.com/categories/nodejs)</code> to learn more about developing and deploying Node.js applications.</li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/22/nodejs4-1/" itemprop="url">
                nodejs学习笔记（五）-- http及相关模块（转载自实验室）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-22T21:42:02+08:00" content="2015-03-22">
            2015-03-22
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nodejs/" itemprop="url" rel="index">
                  <span itemprop="name">nodejs</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/22/nodejs4-1/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/22/nodejs4-1/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>http模块主要用于创建http server服务，此次实验还会讲到url模块和path模块，同时也会用到前面讲过的fs模块。url模块用于解析url，path模块用于处理和转换文件路径。</p>
<p>通过前面的实验，相信大家对Node.js模块的使用已经比较熟悉。在这个实验中，我们就通过编写一个简单的http server来学习http模块。</p>
<p>##一、创建http server<br>通过Node.js创建http server非常简单，示例代码如下：</p>
<pre><code>// 文件名：demo.js

// 引入http模块
var http = require(&apos;http&apos;);

// 创建http server
http.createServer(function (req, res) {
    res.writeHead(200, {&apos;Content-Type&apos;: &apos;text/plain&apos;});
    res.end(&apos;Hello World\n&apos;);
}).listen(1337, &apos;127.0.0.1&apos;);

console.log(&apos;Server running at http://127.0.0.1:1337/&apos;);
</code></pre><p>运行此文件：</p>
<pre><code>$ node demo.js
</code></pre><p>然后打开虚拟机浏览器，访问“<a href="http://127.0.0.1:1337/”，就会看到页面上显示了“Hello" target="_blank" rel="external">http://127.0.0.1:1337/”，就会看到页面上显示了“Hello</a> World”，说明我们的http server创建成功了。</p>
<p>当然，我们在这个实验要做的比这个稍微复杂一点。</p>
<p>在这个实验中，我们会创建一个简单的http server，所有的代码都放在app这个文件夹中。首先，新建一个文app件夹，在文件夹中新建server.js文件，输入如下代码（其中的注释为代码解释）：</p>
<pre><code>//
// 创建http server
//

// 加载所需模块
var http = require(&apos;http&apos;);
var url = require(&apos;url&apos;);
var fs = require(&apos;fs&apos;);

// 设置ip和端口
// 实际应用中，可以把这些写到配置文件中
var host = &apos;127.0.0.1&apos;,
    port = 8080;

// 创建http server
function start(route, handle) {
    // 参数
    // route  判断url是否存在，存在则调用handle处理，不存在则返回404
    // handle 处理不同的url请求


    // 处理request请求
    function onRequest(req, res) {
        // 使用url.parse()方法解析url
        // 它会把url string转化为一个object
        // 这样我们就可以很方便的获取url中的host、port、pathname等值了
        var pathname = url.parse(request.url).pathname;
        console.log(&apos;Request for &apos; + pathname + &apos; received.&apos;);

        // 判断并处理不同url请求
        // 后面介绍此方法
        route(handle, pathname, res, req);
    }

    // 使用http.createSserver()方法创建http server
    // 并传入onRequest()方法
    // 然后使用listen()方法监听指定地址
    http.createServer(onRequest).listen(port, host);
    console.log(&apos;Server has started and listening on &apos; + host + &apos;:&apos; + port);
}

// 导出 start 方法
exports.start = start;
</code></pre><p>在文件的最后，我们导出了start方法，以便在主程序中使用。你肯定注意到了，在代码中使用了route()方法，它用于处理判断请求的url是否存在，现在我们就来编写这个方法。</p>
<p>##二、创建路由<br>在app文件夹中新建router.js，输入如下代码：</p>
<pre><code>// 路由函数
// 处理不同url的请求
// 并返回相应内容
function route(handle, pathname, res, req) {
    console.log(&apos;About to route a request for &apos; + pathname);

    // 判断此url是否存在特定处理函数
    // 存在则调用handle处理
    // 不存在则返回404页面
    if (typeof handle[pathname] === &apos;function&apos;) {
        // 后面介绍handle函数
        handle[pathname](res, req);
    } else {
        console.log(&apos;No request handler found for &apos; + pathname);

        // 读取404页面
        // 所有页面都存放在view文件夹下
        var content = fs.readFileSync(&apos;./views/404.html&apos;);
        res.writeHead(404, { &apos;Content-Type&apos;: &apos;text/html&apos; });
        res.write(content);
        res.end();
    }
}
// 导出 route 方法
exports.route = route;
</code></pre><p>在此方法中，调用了handle()方法，这个方法用于处理不同的url请求。</p>
<p>在app文件夹中新建requestHandlers.js文件，输入如下代码：</p>
<pre><code>// 处理url请求

var fs = require(&apos;fs&apos;);

// home.html 主页
function home(res) {
    console.log(&apos;Request handler &quot;home&quot; was called.&apos;);

    // 读取home.html文件
    var content = fs.readFileSync(&apos;./views/home.html&apos;);
    res.write(200, { &apos;Content-Type&apos;: &apos;text/html&apos; });
    res.write(content);
    res.end();
}

// about.html 关于页面
function about(res) {
    console.log(&apos;Request handler &quot;about&quot; was called.&apos;);

    // 读取about.html文件
    var content = fs.readFileSync(&apos;./views/about.html&apos;);
    res.write(200, { &apos;Content-Type&apos;: &apos;text/html&apos; });
    res.write(content);
    res.end();
}

// 导出页面处理函数
exports.home = home;
exports.about = about;
</code></pre><p>这个方法比较简单，就是读取文件，然后输出到response。</p>
<p>##三、创建主程序<br>创建http server，判断url，处理url都写完了，那么我们可以写主程序来运行http server了，在app文件夹新建main.js文件，输入如下代码：</p>
<pre><code>// 主程序

// 引入server，router及requestHandler
var server = require(&apos;./server&apos;);
var router = require(&apos;./router&apos;);
var requestHandlers = require(&apos;./requestHandlers&apos;);

// 保存url处理方法
var handle = {};
handle[&apos;/&apos;] = requestHandlers.home;
handle[&apos;/about&apos;] = requestHandlers.about;

// 启动http server
server.start(router.router, handle);
</code></pre><p>到此，所有的服务器代码都写完了，那么我们来添加代码中用到的两个html文件吧。</p>
<p>##四、创建HTML文件<br>在app文件夹中新建views文件夹，在views文件夹中，新建home.html文件、about.html文件和404.html文件。</p>
<p>文件中的代码如下所示：</p>
<p>home.html文件：</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;title&gt;Home page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;home page&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>about.html文件：</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;title&gt;About page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;about page&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>404.html文件：</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;title&gt;404 page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;404 page not found&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>HTML文件的代码写得比较简单，可自由发挥。</p>
<p>那么现在我们来运行程序吧：</p>
<pre><code>$ node main.js
</code></pre><p>运行成功后，打开虚拟机桌面的浏览器，访问“<a href="http://127.0.0.1:8080”就会看到页面显示“home" target="_blank" rel="external">http://127.0.0.1:8080”就会看到页面显示“home</a> page”，访问“<a href="http://127.0.0.1:8080/about”就会看到页面显示“about" target="_blank" rel="external">http://127.0.0.1:8080/about”就会看到页面显示“about</a> page”，访问“<a href="http://127.0.0.1:8080”下的其他页面就会看到页面显示“404" target="_blank" rel="external">http://127.0.0.1:8080”下的其他页面就会看到页面显示“404</a> page not found”。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/22/nodejs4/" itemprop="url">
                nodejs学习笔记（四）-- fs模块用于对系统文件及目录进行读写操作(转载实验室)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-22T14:32:49+08:00" content="2015-03-22">
            2015-03-22
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nodejs/" itemprop="url" rel="index">
                  <span itemprop="name">nodejs</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/22/nodejs4/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/22/nodejs4/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>参考链接：<a href="http://nodejs.org/api/fs.html" target="_blank" rel="external">http://nodejs.org/api/fs.html</a></p>
<p>#一、同步和异步<br>使用require(‘fs’)载入fs模块，模块中所有方法都有同步和异步两种形式。</p>
<p>异步方法中回调函数的第一个参数总是留给异常参数（exception），如果方法成功完成，那么这个参数为null或者undefined。</p>
<p>##异步方法实例代码（无需在虚拟机中编写）：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 载入fs模块

fs.unlink(&apos;/tmp/shiyanlou&apos;, function(err) {
    if (err) {
        throw err;
    }
    console.log(&apos;成功删除了 /tmp/shiyanlou&apos;);
});
</code></pre><p>##同步方法实例代码（无需在虚拟机中编写）：</p>
<pre><code>var fs = require(&apos;fs&apos;);

fs.unlinkSync(&apos;/tmp/shiyanlou&apos;); // Sync 表示是同步方法
console.log(&apos;成功删除了 /tmp/shiyanlou&apos;);
</code></pre><p>同步方法执行完并返回结果后，才能执行后续的代码。而异步方法采用回调函数接收返回结果，可以立即执行后续的代码。</p>
<p>#二、readFile读取文件<br>使用fs.readFile(filename, [options], callback)方法读取文件。</p>
<blockquote>
<p>readFile接收三个参数，filename是文件名；[options]是可选的参数，为一个对象，用于指定文件编码（encoding）及操作方式（flag）；callback是回调函数。</p>
</blockquote>
<p>在虚拟机家目录（/home/shiyanlou）下新建一个文件text.txt，文件中的内容如下：</p>
<pre><code>line one
line two
</code></pre><p>使用readFile读取此文件，虚拟机家目录下新建文件readfile.js，输入如下代码并保存：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 引入fs模块

fs.readFile(&apos;./test.txt&apos;, function(err, data) {
    // 读取文件失败/错误
    if (err) {
        throw err;
    }
    // 读取文件成功
    console.log(data);
});
</code></pre><p>readFile的回调函数接收两个参数，err是读取文件出错时触发的错误对象，data是从文件读取的数据。</p>
<p>运行程序：</p>
<pre><code>shiyanlou:~/ $ node readfile.js
</code></pre><p>会看到输出的内容类似于这样：</p>
<pre><code>&lt;Buffer 6c 69 6e 65 20 6f 6e 65 0a 6c 69 6e 65 20 74 77 6f 0a&gt;
</code></pre><p>这是原始二进制数据在缓冲区中的内容。要显示文件内容可以使用toString()或者设置输出编码，readFile.js可以改成这样：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 引入fs模块

// 使用toString()
fs.readFile(&apos;./test.txt&apos;, function(err, data) {
    // 读取文件失败/错误
    if (err) {
        throw err;
    }
    // 读取文件成功
    console.log(&apos;toString: &apos;, data.toString());
});

// 设置编码格式
fs.readFile(&apos;./test.txt&apos;, &apos;utf-8&apos;, function(err, data) {
    // 读取文件失败/错误
    if (err) {
        throw err;
    }
    // 读取文件成功
    console.log(&apos;utf-8: &apos;, data.toString());
});
</code></pre><p>这样再运行程序就能正常显示出文件中的内容了。</p>
<pre><code>fs.readFileSync(filename, [options])是readFile的同步方法。
</code></pre><p>#三、writeFile写入文件<br>使用<code>fs.writeFile(filename, data, [options], callback)</code>写入内容到文件。</p>
<blockquote>
<p>writeFile接收四个参数，filename是文件名称；data是要写入文件的数据；[options]是一个对象为可选参数，包含编码格式（encoding），模式（mode）以及操作方式（flag）；callback是回调函数。</p>
</blockquote>
<p>##writeFile</p>
<p>在虚拟机家目录下新建writeFile.js文件，输入如下代码并保存：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 引入fs模块

// 写入文件内容（如果文件不存在会创建一个文件）
// 写入时会先清空文件
fs.writeFile(&apos;./test2.txt&apos;, &apos;test test&apos;, function(err) {
    if (err) {
        throw err;
    }

    console.log(&apos;Saved.&apos;);

    // 写入成功后读取测试
    fs.readFile(&apos;./test2.txt&apos;, &apos;utf-8&apos;, function(err, data) {
        if (err) {
            throw err;
        }
        console.log(data);
    });
});
</code></pre><p>运行程序：</p>
<pre><code>shiyanlou:~/ $ node writeFile.js
</code></pre><p>如果要追加数据到文件，可以传递一个flag参数，修改代码为如下所示：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 引入fs模块

// 写入文件内容（如果文件不存在会创建一个文件）
// 传递了追加参数 { &apos;flag&apos;: &apos;a&apos; }
fs.writeFile(&apos;./test2.txt&apos;, &apos;test test&apos;, { &apos;flag&apos;: &apos;a&apos; }, function(err) {
    if (err) {
        throw err;
    }

    console.log(&apos;Saved.&apos;);

    // 写入成功后读取测试
    fs.readFile(&apos;./test2.txt&apos;, &apos;utf-8&apos;, function(err, data) {
        if (err) {
            throw err;
        }
        console.log(data);
    });
});
</code></pre><p>运行程序：</p>
<pre><code>shiyanlou:~/ $ node writeFile.js
</code></pre><p>flag传递的值，r代表读取文件，，w代表写入文件，a代表追加写入文件，还有其他的值不作详细介绍。</p>
<p>#四、使用fs.read和fs.write读写文件<br>使用fs.read和fs.write读写文件需要使用fs.open打开文件和fs.close关闭文件。</p>
<p>##1、fs.read()</p>
<p>先介绍fs.open(path, flags, [mode], callback)方法，此方法用于打开文件，以便fs.read()读取。path是文件路径，flags是打开文件的方式，[mode]是文件的权限（可选参数，默认值是0666），callback是回调函数。</p>
<p>flags的值：</p>
<pre><code>r ：读取文件，文件不存在时报错；
r+ ：读取并写入文件，文件不存在时报错；
rs ：以同步方式读取文件，文件不存在时报错；
rs+ ：以同步方式读取并写入文件，文件不存在时报错；
w ：写入文件，文件不存在则创建，存在则清空；
wx ：和w一样，但是文件存在时会报错；
w+ ：读取并写入文件，文件不存在则创建，存在则清空；
wx+ ：和w+一样，但是文件存在时会报错；
a ：以追加方式写入文件，文件不存在则创建；
ax ：和a一样，但是文件存在时会报错；
a+ ：读取并追加写入文件，文件不存在则创建；
ax+ ：和a+一样，但是文件存在时会报错。
</code></pre><p>fs.close(fd, [callback])用于关闭文件，fd是所打开文件的文件描述符。</p>
<p>fs.read(fd, buffer, offset, length, position, callback)方法接收6个参数。</p>
<pre><code>fd是文件描述符，必须接收fs.open()方法中的回调函数返回的第二个参数；
buffer是存放读取到的数据的Buffer对象；
offset指定向buffer中存放数据的起始位置；
length指定读取文件中数据的字节数；
position指定在文件中读取文件内容的起始位置；
callback是回调函数，回调寒素的参数：
err用于抛出异常；
bytesRead是从文件中读取内容的实际字节数；
buffer是被读取的缓存区对象。
</code></pre><p>在家目录中新建文件testread.txt在文件中随意输入一些内容，然后新建read.js文件，输入如下代码并保存：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 引入fs模块

// 打开文件
fs.open(&apos;./testeread.txt&apos;, `r`, function(err, fd) {
    if (err) {
        throw err;
    }
    console.log(&apos;open file success.&apos;);
    var buffer = new Buffer(255);
    // 读取文件
    fs.read(fd, buffer, 0, 10, 0, function(err, bytesRead, buffer) {
        if (err) {
            throw err;
        }
        // 打印出buffer中存入的数据
        console.log(bytesRead, buffer.slice(0, bytesRead).toString());

        // 关闭文件
        fs.close(fd);
    });
});
</code></pre><p>运行程序：</p>
<pre><code>shiyanlou:~/ $ node read.js
</code></pre><p>#2、fs.write()</p>
<p>fs.write(fd, buffer, offset, length, position, callback)方法的参数和fs.read()相同，buffer是需要写入文件的内容。</p>
<p>在家目录中新建文件testwrite.txt，然后新建write.js文件，输入如下代码并保存：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 引入fs模块

// 打开文件
fs.open(&apos;./testwrite.txt&apos;, `w`, function(err, fd) {
    if (err) {
        throw err;
    }
    console.log(&apos;open file success.&apos;);
    var buffer = new Buffer(&apos;shiyanlou&apos;);
    // 读取文件
    fs.write(fd, buffer, 0, 6, 0, function(err, writeten, buffer) {
        if (err) {
            throw err;
        }

        console.log(&apos;write success.&apos;);
        // 打印出buffer中存入的数据
        console.log(bytesRead, buffer.slice(0, bytesRead).toString());

        // 关闭文件
        fs.close(fd);
    });
});
</code></pre><p>运行程序：</p>
<pre><code>shiyanlou:~/ $ node write.js
</code></pre><p>#五、目录操作</p>
<p>##1、创建目录</p>
<p>使用fs.mkdir(path, [mode], callback)创建目录，path是需要创建的目录，[mode]是目录的权限（默认值是0777），callback 是回调函数。</p>
<p>在家目录下创建mkdir.js文件，输入如下代码并保存：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 引入fs模块

// 创建 newdir 目录
fs.mkdir(&apos;./newdir&apos;, function(err) {
    if (err) {
        throw err;
    }
    console.log(&apos;make dir success.&apos;);
});
</code></pre><p>运行代码：</p>
<pre><code>shiyanlou:~/ $ node mkdir.js
</code></pre><p>运行程序后会发现在当前目录下已经创建了newdir目录，删除目录可以使用fs.rmdir(path, callback)，但是只能删除空目录。</p>
<p>##2、读取目录</p>
<p>使用fs.readdir(path, callback)读取文件目录。</p>
<p>在家目录下新建readdir.js文件，输入如下代码并保存：</p>
<pre><code>var fs = require(&apos;fs&apos;); // 引入fs模块

fs.readdir(&apos;./newdir&apos;, function(err, files) {
    if (err) {
        throw err;
    }
    // files是一个数组
    // 每个元素是此目录下的文件或文件夹的名称
    console.log(files);
});
</code></pre><p>运行代码：</p>
<pre><code>shiyanlou:~/ $ node readdir.js
</code></pre><p>#六、结束<br>fs模块中还有很多其他方法，其使用与前面介绍的方法类似，在此不一一介绍，可自行查阅官方API文档。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/21/nodejs3/" itemprop="url">
                nodejs学习笔记（三）-- Node.js Events模块(转载实验室)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-21T23:17:12+08:00" content="2015-03-21">
            2015-03-21
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nodejs/" itemprop="url" rel="index">
                  <span itemprop="name">nodejs</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/21/nodejs3/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/21/nodejs3/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>#一、Node.js Events模块<br>在Node.js中，很多对象都会发出事件。比如，fs.readStream打开文件时会发出一个事件。所有发出事件的对象都是events.EventEmitter的实例，可以通过require(“events”);获得event模块。</p>
<p>通常，事件名采用“驼峰式”命名方式，但是，并没有严格规定。这只是推荐的命名方法。</p>
<p>函数可以添加给对象，对象发出事件时，对应函数就会被执行。这些函数被称作监听器（listeners）。在监听器函数中，this引用的是它（指此监听器函数）添加到的EventEmitter对象。</p>
<p>##1. Class: events.EventEmitter<br>通过require(‘events’).EventEmitter得到EventEmitter类。</p>
<p>当EventEmitter对象遇到错误时，通常会触发error事件。error事件在Node.js中是一种特殊情况，如果没有监听器，那么默认会打印出栈跟踪器并退出程序。</p>
<p>###添加监听器</p>
<p>为事件绑定事件处理程序，可以使用emitter.addListener(event, listener)和emitter.on(event, listener)，它们的作用是完全一样的。传入的参数是事件（event）和处理函数（listener）。</p>
<p>在虚拟机桌面新建文件test1.js，输入如下代码并保存：</p>
<pre><code>var http = require(&apos;http&apos;);
var server = http.createServer();

// 为request事件绑定处理函数
// 也可以使用server.addListener
server.on(&apos;request&apos;, function(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;shiyanlou&apos;);
    console.log(&apos;shiyanlou&apos;);
    res.end();
});

server.listen(1337, &apos;127.0.0.1&apos;);
console.log(&apos;Server running at http://127.0.0.1:1337/&apos;);
</code></pre><p>运行代码：</p>
<pre><code>shiyanlou@sdf234jh4:~$ cd Desktop
shiyanlou@sdf234jh4:~/Desktop$ node test1.js
</code></pre><p>然后打开虚拟机桌面的Firefox浏览器，在地址栏输入127.0.0.1:1337，即可看到页面上打印出了“shiyanlou”字样，同时console界面也会输出’shiyanlou’字样。</p>
<p>###只执行一次的监听器</p>
<p>使用emitter.once(event, listener)绑定的事件监听器只会执行一次，然后就会被删除掉。</p>
<p>在虚拟机桌面新建文件test2.js，输入如下代码并保存：</p>
<pre><code>var http = require(&apos;http&apos;);
var server = http.createServer();

// 为request事件绑定处理函数，事件只会执行一次
server.once(&apos;request&apos;, function(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;shiyanlou&apos;);
    console.log(&apos;shiyanlou&apos;);
    res.end();
});

server.listen(1337, &apos;127.0.0.1&apos;);
console.log(&apos;Server running at http://127.0.0.1:1337/&apos;);
</code></pre><p>运行代码：</p>
<p>shiyanlou@sdf234jh4:~/Desktop$ node test2.js<br>打开虚拟机桌面的Firefox浏览器，在地址栏输入127.0.0.1:1337，即可看到页面上打印出了“shiyanlou”字样，再次刷新此页面，就不会再显示，因为此事件只会执行一次。</p>
<p>###移除监听器</p>
<p>移除监听器使用emitter.removeListener(event, listener)。</p>
<p>在虚拟机桌面新建文件test3.js，输入如下代码并保存：</p>
<pre><code>var http = require(&apos;http&apos;);
var server = http.createServer();

function callback(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;Hello World&apos;);
    console.log(&apos;Hello World&apos;);
    res.end();
}

server.on(&apos;request&apos;, callback);

// 移除绑定的监听器callback
server.removeListener(&apos;request&apos;, callback);

server.on(&apos;request&apos;, function(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;shiyanlou&apos;);
    console.log(&apos;shiyanlou&apos;);
    res.end();
});

server.listen(1337, &apos;127.0.0.1&apos;);
console.log(&apos;Server running at http://127.0.0.1:1337/&apos;);
</code></pre><p>运行代码：</p>
<pre><code>shiyanlou@sdf234jh4:~/Desktop$ node test3.js
</code></pre><p>打开虚拟机桌面的Firefox浏览器，在地址栏输入127.0.0.1:1337，即可看到页面上打印出了“shiyanlou”字样，为什么没有显示“Hello World”呢？因为显示“Hello World”的监听器被移除了。</p>
<p>###移除所有监听器</p>
<p>移除所有监听器使用emitter.removeAllListeners([event])。</p>
<p>在虚拟机桌面新建文件test4.js，输入如下代码并保存：</p>
<pre><code>var http = require(&apos;http&apos;);
var server = http.createServer();

server.on(&apos;request&apos;, function(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;shiyanlou,111&apos;);
    console.log(&apos;shiyanlou,111&apos;);
    res.end();
});

server.on(&apos;request&apos;, function(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;shiyanlou,222&apos;);
    console.log(&apos;shiyanlou,222&apos;);
    res.end();
});

// 移除绑定的所有监听器
server.removeAllListeners(&apos;request&apos;);

server.on(&apos;request&apos;, function(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;shiyanlou&apos;);
    console.log(&apos;shiyanlou&apos;);
    res.end();
});

server.listen(1337, &apos;127.0.0.1&apos;);
console.log(&apos;Server running at http://127.0.0.1:1337/&apos;);
</code></pre><p>运行代码：</p>
<pre><code>shiyanlou@sdf234jh4:~/Desktop$ node test4.js
</code></pre><p>打开虚拟机桌面的Firefox浏览器，在地址栏输入127.0.0.1:1337，即可看到页面上打印出了“shiyanlou”字样，说明前面的监听器被移除了，都没有执行，所以没有显示，同时console界面也只会输出’shiyanlou’字样。</p>
<p>###设置监听器最大绑定数</p>
<p>emitter.setMaxListeners(n)可以设置同一事件的监听器最大绑定数，默认情况下，超过10个就会警告提示，这能帮我们快速找到类存泄露的地方。显然，不是所有的事件触发器都限制在10个监听器，通过这个方法可以设置，如果设置为0就是无限制。</p>
<p>###自定义事件</p>
<p>使用emitter.emit(event, [arg1], [arg2], […])可以触发自定义的事件。</p>
<p>在虚拟机桌面新建文件test5.js，输入如下代码并保存：</p>
<pre><code>var http = require(&apos;http&apos;);
var server = http.createServer();

// 绑定自定义事件myevent
server.on(&apos;myevent&apos;, function(arg) {
    console.log(arg);
});

// 触发自定义事件
server.emit(&apos;myevent&apos;, &apos;shiyanlou&apos;);

server.listen(1337, &apos;127.0.0.1&apos;);
console.log(&apos;Server running at http://127.0.0.1:1337/&apos;);
</code></pre><p>运行代码：</p>
<pre><code>shiyanlou@sdf234jh4:~/Desktop$ node test5.js
</code></pre><p>可以看到console界面输出了’shiyanlou’字样，说明触发自定义事件成功。</p>
<p>###查看事件绑定的监听器个数</p>
<p>使用EventEmitter.listenerCount(emitter, event)可以查看事件监听器数量。</p>
<p>在虚拟机桌面新建文件test6.js，输入如下代码并保存：</p>
<pre><code>var http = require(&apos;http&apos;);
var events = require(&apos;events&apos;); // 加载events模块
var server = http.createServer();

server.on(&apos;request&apos;, function(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;shiyanlou,111&apos;);
    console.log(&apos;shiyanlou,111&apos;);
    res.end();
});

server.on(&apos;request&apos;, function(req, res) {
    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });
    res.write(&apos;shiyanlou,222&apos;);
    console.log(&apos;shiyanlou,222&apos;);
    res.end();
});

server.listen(1337, &apos;127.0.0.1&apos;);
console.log(&apos;Server running at http://127.0.0.1:1337/&apos;);

// 查看server绑定的&apos;request&apos;事件的监听器个数
var num = events.EventEmitter.listenerCount(server, &apos;request&apos;);
console.log(num);
</code></pre><p>运行代码：</p>
<pre><code>shiyanlou@sdf234jh4:~/Desktop$ node test6.js
</code></pre><p>可以看到console界面输出了数字“2”，因为server绑定了两个监听器到’request’事件。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/21/nodejs2-1/" itemprop="url">
                nodejs学习笔记（二）-- module.exports和exports(转载自实验室)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-21T22:12:44+08:00" content="2015-03-21">
            2015-03-21
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/nodejs/" itemprop="url" rel="index">
                  <span itemprop="name">nodejs</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/21/nodejs2-1/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/21/nodejs2-1/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>##1. 模块的使用<br>编写一个模块：</p>
<p>在虚拟机桌面新建一个文件mymodule.js，输入如下代码并保存：</p>
<pre><code>function hello() {
    console.log(&apos;Hello&apos;);
}

function world() {
    console.log(&apos;World&apos;);
}
</code></pre><p>这就是一个Node.js模块，但是怎么在其他模块中引入并使用这个模块呢？我们需要为模块提供对外的接口，这就要用到module.exports和exports。</p>
<p>我们可以这样写<code>mymodul.js</code>：</p>
<pre><code>function hello() {
    console.log(&apos;Hello&apos;);
}

function world() {
    console.log(&apos;World&apos;);
}

exports.hello = hello;
exports.world = world;
</code></pre><p>在其他模块中，可以使用require(module_name);载入需要的模块，如，在虚拟机桌面新建index.js，输入如下代码并保存：</p>
<pre><code>var hello = require(&apos;./mymodule&apos;); // 也可以写作 var hello = require(&apos;./mymodule.js&apos;);
</code></pre><p>// 现在就可以使用mymodule.js中的函数了</p>
<pre><code>hello.hello(); // &gt;&gt; Hello
hello.world(); // &gt;&gt; World
</code></pre><p>也可以这样写<code>mymodule.js</code>：</p>
<pre><code>function Hello() {
    this.hello = function() {
        console.log(&apos;Hello&apos;);
    };

    this.world = function() {
        console.log(&apos;World&apos;);
    };
}

module.exports = Hello;
</code></pre><p>此时，index.js就要改成这样：</p>
<pre><code>var Hello = require(&apos;./mymodule&apos;);

var hello = new Hello();

hello.hello(); // &gt;&gt; Hello
hello.world(); // &gt;&gt; World
</code></pre><p>##2. module.exports和exports<br>module是一个对象，每个模块中都有一个module对象，module是当前模块的一个引用。module.exports对象是Module系统创建的，而exports可以看作是对module.exports对象的一个引用。在模块中require另一个模块时，以module.exports的值为准，因为有的情况下，module.exports和exports它们的值是不同的。module.exports和exports的关系可以表示成这样：</p>
<pre><code>// module.exports和exports相同的情况
var m = {};        // 表示 module
var e = m.e = {};  // e 表示 exports， m.e 表示 module.exports

m.e.a = 5;
e.b = 6;

console.log(m.e);  // Object { a: 5, b: 6 }
console.log(e);    // Object { a: 5, b: 6 }


// module.exports和exports不同的情况
var m = {};        // 表示 module
var e = m.e = {};  // e 表示 exports， m.e 表示 module.exports

m.e = { c: 9 };    // m.e（module.exports）引用的对象被改了
e.d = 10;

console.log(m.e);  // Object { c: 9 }
console.log(e);    // Object { d: 10 }
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/20/mac升级后mysql无法启动/" itemprop="url">
                mac升级yosemite之后xampp中mysql不能启动的问题解决(转载)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-20T23:22:55+08:00" content="2015-03-20">
            2015-03-20
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/linux-unix-macos/" itemprop="url" rel="index">
                  <span itemprop="name">linux/unix/macos</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/20/mac升级后mysql无法启动/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/20/mac升级后mysql无法启动/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>这是xampp和优胜美地的不兼容造成了，新版本的xampp已经修复了这个bug。对于不想升级xampp同时又想修复这个问题的同学，可以按照以下方式解决：<br>1、打开/Applications/XAMPP/xamppfiles/xampp进行编辑<br>2、找到这一行：$XAMPP_ROOT/bin/mysql.server start &gt; /dev/null &amp;<br>3、添加如下一行在找到的那一行上面：unset DYLD_LIBRARY_PATH，结果如下：<br>unset DYLD_LIBRARY_PATH<br>$XAMPP_ROOT/bin/mysql.server start &gt; /dev/null &amp;</p>
<p>然后即可启动mysql</p>
<p>参考：<a href="https://community.bitnami.com/t/mysqld-doesnt-start-in-mac-os-yosemite/25153/6" target="_blank" rel="external">https://community.bitnami.com/t/mysqld-doesnt-start-in-mac-os-yosemite/25153/6</a><br>转自：<a href="http://www.zhujianfeng.info/?p=234" target="_blank" rel="external">http://www.zhujianfeng.info/?p=234</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/19/thinkphp动态表单/" itemprop="url">
                thinkphp动态表单
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-19T10:54:06+08:00" content="2015-03-19">
            2015-03-19
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/19/thinkphp动态表单/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/19/thinkphp动态表单/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/18/thinkphp-relation/" itemprop="url">
                thinkphp中的关联模型
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-03-18T21:21:47+08:00" content="2015-03-18">
            2015-03-18
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/03/18/thinkphp-relation/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/18/thinkphp-relation/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>##thinkphp模型介绍<br>在thinkphp中有三种模型</p>
<p>###普通模型<br>一般使用普通模型的时候我们是用来处理一个表的<br>通常使用的M(‘user’) (<em>M当中的数据表只能小写</em>)</p>
<p>###视图模型</p>
<p>###关联模型<br>如下为一个关联模型的文件 </p>
<pre><code>&lt;?php
/**
 * 用户与角色关联模型
 */
class UserRelationModel extends RelationModel{
    //定义主表名称
    protected $tableName = &apos;user&apos;;

    //定义关联关系
    protected $_link = array(
        &apos;role&apos; =&gt; array(
            &apos;mapping_type&apos; =&gt; MANY_TO_MANY,//多对多关系，关联关系
            &apos;foreign_key&apos; =&gt; &apos;user_id&apos;,//主表在中间表中的字段名称
            &apos;relation_key&apos; =&gt; &apos;role_id&apos;,//副表在中间表中的字段名称
            &apos;relation_table&apos; =&gt; &apos;think_role_user&apos;,//中间表名称
            &apos;mapping_fields&apos; =&gt; &apos;id, name, remark&apos;,//只读取副表的这些字段
            )
        );
}
?&gt;
</code></pre><p>读取主表</p>
<pre><code>$user = D(&apos;UserRelation&apos;)-&gt;select()
</code></pre><p>读取主表和用户表</p>
<pre><code>$user = D(&apos;UserRelation&apos;)-&gt;relation(&apos;role&apos;)-&gt;select();
</code></pre><p>读取主表中除了password之外的所有字段</p>
<pre><code>$user = D(&apos;UserRelation&apos;)-&gt;field(&apos;password&apos;,true)-&gt;relation(true)-&gt;select();
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/">&laquo;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/8/">&raquo;</a>
  </nav>

 </div>

        

        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="http://7xltvd.com1.z0.glb.clouddn.com/default_avatar.jpg" alt="zhanfang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">zhanfang</p>
        </div>
        <p class="site-description motion-element" itemprop="description">詹方的个人博客</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">145</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">24</span>
              <span class="site-state-item-name">categories</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">79</span>
              <span class="site-state-item-name">tags</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhanfang" target="_blank">GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/2840048377/profile?topnav=1&wvr=6" target="_blank">Weibo</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.demozhan.com/default" target="_blank">我的作品</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhanfang</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>
<div class="theme-info">© zhanfang 2015 陕ICP备15014665号-1</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhanfang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>

  <script>
    (function(){
        var bp = document.createElement('script');
        bp.src = '//push.zhanzhang.baidu.com/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
  </script>

</body>
</html>
